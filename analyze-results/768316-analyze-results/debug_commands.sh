#!/bin/bash
# Debug Commands for ReportPortal Launch 768316 Failures
# Generated by CI Failure Analysis workflow

echo "=== Debug Commands for Launch 768316 Failures ==="
echo

# Product Bug Investigation (High Priority)
echo "=== OVN IPv4 Subnet Configuration Investigation (OCP-78024/81347) ==="
echo "# Check node gateway router annotations"
echo "oc get nodes -o yaml | grep -A10 -B5 'node-gateway-router-lrp-ifaddrs'"
echo
echo "# Check OVN configuration on cluster"
echo "oc get network.operator cluster -o yaml"
echo "oc get network.config cluster -o yaml | grep -A5 -B5 subnet"
echo
echo "# Check install config for custom subnet"
echo "oc get clusterdeployment <cd-name> -o jsonpath='{.spec.platform.aws.internalJoinSubnet}'"
echo
echo "# Check provision logs for networking setup"
echo "oc logs -n hive <provision-job-pod> -c installer | grep -i ovn"
echo

echo "=== Pull Secret Validation Investigation (OCP-25145) ==="
echo "# Check pull secret content and completeness"
echo "oc get secret pull-secret -n openshift-config -o yaml"
echo "oc get hiveconfig cluster -o jsonpath='{.spec.globalPullSecretRef}'"
echo
echo "# Check ClusterDeployment provision timing"
echo "oc get clusterdeployment <cd-name> -o yaml | grep -A10 conditions"
echo "oc describe clusterdeployment <cd-name> | grep -A20 Conditions"
echo

echo "=== ClusterPool MachinePool Creation Investigation (OCP-33832/42251/43033) ==="
echo "# Check ClusterPool status and timing"
echo "oc get clusterpool <pool-name> -o yaml"
echo "oc get clusterdeployment -A | grep pool-"
echo
echo "# Check MachinePool creation status"
echo "oc get machinepool -A"
echo "oc describe machinepool <pool-machinepool-name> -n <namespace>"
echo
echo "# Check MCE dependencies"
echo "oc get crd | grep multiclusterengine"
echo

# Infrastructure Issues
echo "=== Image Pull Secret Investigation (OCP-28631) ==="
echo "# Check specific image pull secret status"
echo "oc get secret hive-operator-dockercfg-kkvfl -n hive -o yaml"
echo "oc describe secret hive-operator-dockercfg-kkvfl -n hive"
echo
echo "# Check service account and RBAC"
echo "oc describe serviceaccount hive-operator -n hive"
echo "oc auth can-i get secrets --as=system:serviceaccount:hive:hive-operator -n hive"
echo
echo "# Check pod status and events"
echo "oc get pods -l app=hive-controllers -n hive"
echo "oc describe pod -l app=hive-controllers -n hive"
echo "oc get events -n hive --sort-by='.lastTimestamp' | grep -i secret"
echo

echo "=== Timing Precision Investigation (OCP-35209) ==="
echo "# Check ClusterClaim lifecycle timing"
echo "oc get clusterclaim -A -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.metadata.creationTimestamp}{"\t"}{.spec.lifetime}{"\t"}{.metadata.deletionTimestamp}{"\n"}{end}'"
echo
echo "# Check ClusterPool lifetime configuration"
echo "oc get clusterpool <pool-name> -o jsonpath='{.spec.claimLifetime}'"
echo
echo "# Monitor controller performance"
echo "oc logs deployment/hive-controllers -n hive | grep -i claim"
echo

# E2E Test Issues
echo "=== Status Synchronization Investigation (OCP-28867/41776, OCP-34148) ==="
echo "# Check MachinePool and MachineSet status alignment"
echo "oc get machinepool <pool-name> -o jsonpath='{.status.replicas}'"
echo "oc get machinesets -n openshift-machine-api -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.status.replicas}{"\n"}{end}'"
echo
echo "# Check spot instance machine set status"
echo "oc get machineset <spot-machineset-name> -n openshift-machine-api -o yaml | grep -A5 -B5 status"
echo
echo "# Check ClusterAutoscaler configuration"
echo "oc get clusterautoscaler default -o yaml"
echo

echo "=== Test Orchestration Investigation (OCP-46016) ==="
echo "# Check HiveConfig retry reasons configuration"
echo "oc get hiveconfig cluster -o jsonpath='{.spec.failedProvisionConfig.retryReasons}'"
echo
echo "# Check ClusterDeployment provision conditions"
echo "oc get clusterdeployment <cd-name> -o jsonpath='{.status.conditions[?(@.type==\"ProvisionFailed\")]}'"
echo
echo "# Check provision pod status and logs"
echo "oc get pods -A | grep provision"
echo "oc logs <provision-pod> -n <namespace> | tail -50"
echo

echo "=== General Hive Health Checks ==="
echo "# Check Hive operator and controllers status"
echo "oc get deployment hive-operator -n hive"
echo "oc get deployment hive-controllers -n hive"
echo "oc logs deployment/hive-operator -n hive --tail=50"
echo "oc logs deployment/hive-controllers -n hive --tail=50"
echo
echo "# Check cluster version and resource availability"
echo "oc get clusterversion"
echo "oc get nodes"
echo "oc describe nodes | grep -A5 -B5 'Allocated resources'"
echo
echo "# Check registry connectivity"
echo "oc get imagestream -n openshift || echo 'No imagestreams found'"
echo "oc get pods -A | grep ImagePullBackOff"
echo
echo "=== Environment Validation ==="
echo "# Check for resource contention"
echo "oc top nodes"
echo "oc top pods -A --sort-by=memory"
echo
echo "# Check API server performance"
echo "oc get --raw /metrics | grep apiserver_request_duration"
echo
echo "# Check test environment setup"
echo "oc get ns | grep -E 'hive|test'"
echo "oc get crd | grep hive"
echo
echo "=== End Debug Commands ==="