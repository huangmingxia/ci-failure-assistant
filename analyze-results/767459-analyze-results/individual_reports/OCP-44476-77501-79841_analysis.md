# Individual Analysis Report: OCP-44476/77501/79841

## Summary
- **Case IDs**: OCP-44476, OCP-77501, OCP-79841 (duplicate test runs)
- **Test Title**: Change fields of a steady pool with CDC enabled, all unclaimed clusters will be recreated
- **Failure Description**: Test failed after 368.97 seconds when checking Prometheus metric `hive_clusterpool_stale_clusterdeployments_deleted`
- **Timestamp**: Failed during launch 767459

## Root Cause
**Primary Issue**: Metrics Collection Timing Issue
- Test expects `hive_clusterpool_stale_clusterdeployments_deleted` metric to equal "2" after imageSetRef change
- Metric polling timed out without finding expected value
- Controller reconciliation may not have completed deletion cycle

**Contributing Factors**:
- Metric update requires specific conditions: `drift == 0`, `len(cds.Installing()) == 0`, `len(cds.Stale()) > 0`
- Prometheus scraping interval delays between metric increment and availability
- Pool's `maxConcurrent: 1` setting may limit deletion speed
- Fake cluster mode (`fake: "true"`) might affect timing

## Failure Type & Risk
**Classification**: E2E Bug (most likely) or Infrastructure Issue
**Risk Level**: Medium
- Low functional impact - CDC functionality likely works correctly
- Medium test reliability impact - timing-sensitive test behavior
- No evidence of actual product defects

## Evidence
- Test duration: 368.97 seconds (~6 minutes) suggests timeout waiting for metric
- Failure at line 5638 checking metric value
- Query: `hive_clusterpool_stale_clusterdeployments_deleted`
- Expected value: "2", actual: unknown (timeout)
- Generic error: "error: can not get expected result"

## Recommendations

### Immediate Fix
1. **Increase Metric Polling Timeout**: Extend beyond current ClusterResumeTimeout calculation

2. **Add Intermediate Validation**:
   ```go
   // Validate stale clusters actually deleted before checking metrics
   newCheck("expect", "get", asAdmin, withoutNamespace, contain, "0", ok, DefaultTimeout, 
       []string{"ClusterDeployment", "-A", "--field-selector=metadata.annotations['hive.openshift.io/cluster-pool-name']=" + poolName}).check(oc)
   ```

3. **Enhanced Debugging**: Log current metric value and pool state before final assertion

### Long-term Prevention
1. **Separate Validations**: Split functional validation from metrics verification
2. **Optional Metrics**: Add environment variable to skip metrics validation in unstable environments
3. **Better Error Reporting**: Implement metric validation with retry and detailed error context
4. **Test Architecture**: Different timeout values for different validation phases