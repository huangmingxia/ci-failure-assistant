# Test Case Analysis: OCP-22760 (Runtime Panic)

**Associated Cases**: OCP-22760, OCP-23165, OCP-25310, OCP-33374, OCP-39747  
**Test Name**: [HiveSDRosa] Hive ClusterDeployment Check installed and version [Serial]  
**Failure Type**: Runtime panic  
**Analysis Date**: September 2, 2024  
**Launch ID**: 768194

## Summary

Critical runtime panic in Hive E2E test framework due to improper handling of OCI digest-based image references. The test expects tag-based image format (`:version-`) but receives digest format (`@sha256:`), causing array index out of bounds panic during version parsing.

## Root Cause

**Primary Issue**: `extractRelFromImg` function in `hive_util.go:1470-1482` cannot parse digest-based image references

**Technical Details**:
- **Expected format**: `registry:4.19.0-nightly-...`
- **Actual format**: `registry@sha256:f07b4744b52961937ae049a7029d5639205bafbc33780f080094e1063fecb2d1`
- **Failure point**: `hive_aws.go:2553` - array access `xyzVersion[1]` on empty array
- **Root function**: `extractRelFromImg` returns empty string for digest references

## Evidence

### Key Log Entries
```
[null] ERROR: fail [runtime/panic.go:115]: Test Panicked: runtime error: index out of range [1] with length 1
I0901 08:05:55.487343 4004 openshift-tests.go:202] Is kubernetes cluster: no, is external OIDC cluster: no
Failed to extract OCP release from Image.
```

### Code Location
- **File**: `/go/src/github.com/openshift/openshift-tests-private/test/extended/cluster_operator/hive/hive_aws.go:2553`
- **Function**: Version parsing logic in test setup
- **Panic trigger**: `minorVersion := xyzVersion[1]` when `xyzVersion` has length 1

## Classification

**Type**: E2E Bug  
**Risk Level**: HIGH  
**Confidence**: High

**Rationale**: Test framework cannot handle standard OCI image digest references used in CI environments. This is not a Hive product bug but a test infrastructure issue.

## Impact Assessment

- **Test Coverage**: Zero - no Hive functionality validated
- **CI Pipeline**: Blocks E2E validation for Hive operator
- **Development**: Prevents verification of Hive-related changes
- **Release Risk**: Cannot detect actual Hive regressions

## Recommendations

### Immediate Fix
1. **Enhance `extractRelFromImg` function**:
   ```go
   func extractRelFromImg(image string) string {
       if strings.Contains(image, "@sha256:") {
           return getVersionFromClusterVersion()
       }
       // Existing tag-based parsing...
   }
   ```

2. **Add input validation**:
   ```go
   xyzVersion := strings.Split(ocpVersion, ".")
   if len(xyzVersion) < 3 {
       e2e.Failf("Invalid OCP version format: %s", ocpVersion)
   }
   ```

### Long-term Prevention
- Replace manual parsing with OCP API calls
- Support both tag and digest image references
- Implement comprehensive input validation
- Add graceful error handling instead of panics

## Debug Commands

```bash
# Reproduce issue with digest-based image
oc get clusterversion -o jsonpath='{.status.desired.image}'

# Test version extraction
oc get clusterversion -o jsonpath='{.status.desired.version}'

# Verify Hive operator status
oc get clusterdeployments -A
```

---
*Report generated by CI Failure Analysis Tool*